测试
========

这一级目录中存放本项目相关的测试，主要分为两个部分：

| 目录 | 启动文件 | 配置文件 | 内容 |
| -------- | -------- | -------- | -------- |
| `unit/` | `bootstrap.php` | `phpunit.xml` | 单元测试，比如公共工具类，框架基类，等 |
| `api/` | `bootstrap.api.php` | `phpunit.api.xml` | 接口测试，使用无头浏览器直接访问各数据接口，模拟真实使用场景 |

## 单元测试

单元测试会针对框架的基础构成进行测试，比如 `Utils`、`Model`、`Collection` 等，目的在于验证它们是否能够正常工作。这部分的测试要求完全覆盖，接下来的接口测试将默认这些测试已经通过，所有的工具都是可用的。

一些类的特定方法也会在这里进行测试，不过暂时不要求覆盖率。

### 运行测试

    phpunit

也可以测试某个特定功能：

    phpunit --testsuite ad // 测试 ad 组件下的功能

## 接口测试（行为测试）

接口测试的目的是保证所有接口正常工作，输入输出符合预期。这里暗含的前提是：接口正常工作，用户至少会觉得系统正常。

接口测试要求100%覆盖，即每个接口至少都有一个测试。

发现任何接口出问题，或者某个问题可以在接口测试时进行检查，就增加一个测试用例。

### Friday

`Friday` 是我们用来组织测试的基础类，他由 phpunit 的基础上封装得来。有了他的帮助，我们可以使用接口描述替换大部分的标准化测试，只要写少量的接口描述就可以了。

接口描述是标准的 JSON 文档，格式大体如下：

```json
{
  "ad/": [
    {
      "method": "GET",
      "input": {
        "query": {
          "page": 1,
          "pageSize": 20
        }
      },
      "output": {
        "id": "^[a-f0-9]{32}$",
        "ad_app_type": "number",
        "status": "int",
        "ad_name": "string",
        "provinces": [0, 1, 2]
        ....
      },
      "timeout": 5
    }
    ....
  ]
  ....
}
```

首先，定义接口访问的路径为 `ad/`，然后对这个接口的输入输出做出定义。对一个接口可以定义多个测试。定义的标准如下表所示：

| 字段 | 说明 | 接受值 |
| -------- | -------- | -------- |
| `method` | 访问接口的方法 | `GET`，`PATCH`，`POST`，`DELETE`，理论上这里可以使用任何自定义方法，不过建议一定要符合语义 |
| `output` | 定义输出的内容 | 对每个字段的定义 |
| `input` | 定义传递给接口的参数 | |
| `input.query` | 使用 `GET` 方法传递给接口的参数 | 形如：`a=1&b=2&c=3` 的字符串；或者标准 JSON 对象，会使用 `http_build_query` 进行拼接 | 
| `input.json` | 使用 `POST` 或其它方法传递给接口的完整信息 | 标准 JSON 格式 |
| `input.form` | 使用前面定义的方法传递给接口的参数 | 标准 JSON 格式 |
| `input.header` | 需要发出的特殊头部，直接写信息即可 | 如：`Content-type: application/json;' |
| `timeout` | 设置接口完成请求应该花费的最大时长 | 数值，以秒为单位，如：`10` 表示10秒 |
| `response` | 定义返回的头信息 | 标准 JSON 格式 |
| `response.statusCode` | HTTP 状态码 | 数值 |

从 `output` 开始，都采用相同的定义方式，即如果是字符串，则相当于 `type`，其它可能用到的定义如下所示：

| 字段 | 说明 | 接受值 |
| -------- | -------- | -------- |
| `type` | 值的类型，必须符合描述才能通过，默认接受 `null`，除非定义了 `not_null` | 具体内容见 [附录1](#appendix-1) |
| `item` | 如果 `type=array`，那么可以通过此字段定义每个元素的数据结构 | 数组，里面是具体的定义 | 
| `not_exist` | 此键值不应存在 | `true` 实际上任意值都会触发生效 |
| `not_null` | 此值不能为 null | 同上 |
| `not_empty` | 此值不能为空，比如 `''` | 同上 |
| `maxlength` | 文本的长度上限 | 数字 |
| `minlength` | 文本的长度下限 | 数字 |
| `max` | 最大值 | 数字 |
| `min` | 最小值 | 数字 |

### 接口测试方案

* [开始测试](./get-started.md)
* [测试创建、更新、删除](./test-create-update-delete.md)
* [测试创建后的结果](./test-with-mysql.md)

--------

<a name="appendix-1"></a>
### 附录1

| 类型描述 | 含义 |
| -------- | -------- |
| `string` | 文本，不限长度 |
| `number` | 数值，泛指整数、小数、科学计数法、16位等，包括可以转换成数字的字符，比如 `'1'` 等 |
| `array` | 数组，可以进一步定义 |
| `array.item` | 数组里某个元素应该包含的字段和类型 |
| `object` | 对象，可以进一步定义 |
| `object.fields` | 对象的字段及其类型 |
| `date` | 日期，格式为 `YYYY-MM-DD` |
| `time` | 时间，格式为 `HH:ii:ss` |
| `datetime` | 日期时间，格式为 `YYYY-MM-DD HH:ii:ss` |
| `int` | 整数，必须是严格意义上的整数，不包含字符串 |
| `uint` | 自然数，必须是严格意义上的整数，不包含字符串 |
| `float` | 小数，必须是严格意义上的小数，不包含字符串 |
| `boolean` | 布尔值 |
| `url` | 网址 |
| `email` | 电子邮件地址 |
| `ip` | IP地址 |
| 数字 | 值必须等于定义的值 |
| 数组 | 值必须完全等于定义的数组 |
| 正则 | 必须匹配正则 |